when:
  event: [manual, push]
  branch: main
  path:
    - .woodpecker/build.yaml
    - api/**
    - app/**
    - service/**
    - image/**
    - pom.xml
    - lombok.config

services:
  - name: dockerd
    image: ghcr.io/grayc-de/plugins/dockerd
    ports: [2375]
    privileged: true
    backend_options:
      kubernetes:
        securityContext:
          privileged: true

steps:

  deploy:
    image: ghcr.io/grayc-de/plugins/maven
    environment: [DOCKER_HOST=tcp://dockerd:2375]
    commands:
      - mkdir $HOME/.docker && echo "$DOCKER_CONFIG_JSON" > $HOME/.docker/config.json
      - mvn deploy -pl image -am -Dcheck.skip -DskipTests -T1C
    secrets: [DOCKER_CONFIG_JSON]

  restart:
    image: ghcr.io/grayc-de/plugins/kubectl
    commands:
      - echo $KUBE_CERTIFICATE | base64 -d > ca-certificate
      - kubectl config set-cluster grayc-live --server=https://$KUBE_HOST --certificate-authority=ca-certificate
      - kubectl config set-credentials restarter --token=$KUBE_TOKEN
      - kubectl config set-context inoa-dev --cluster=grayc-live --namespace=inoa-dev --user=restarter
      - kubectl config use-context inoa-dev
      - kubectl rollout restart deployment/inoa
      - kubectl rollout status deployment/inoa --timeout=10m
    # stored as repo secret in https://ci.grayc.io/repos/inoa/cloud/settings
    # definition: https://git.grayc.io/grayc/inoa/src/branch/main/fluxcd/live/dev/service-account/rbac.yaml
    # token: kubectl --namespace inoa-dev get secret restarter -ojson | jq -r .data.token | base64 -d
    secrets: [KUBE_TOKEN]

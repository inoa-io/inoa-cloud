when:
  event: [manual, push]
  branch: main
  path:
    - .woodpecker/build.yaml
    - api/**
    - app/**
    - service/**
    - image/**
    - pom.xml
    - lombok.config

services:
  - name: inoa-dockerd-build
    image: ghcr.io/grayc-de/plugins/dockerd
    privileged: true
    ports: [2375]

steps:

  deploy:
    image: ghcr.io/grayc-de/plugins/maven
    environment: [DOCKER_HOST=tcp://inoa-dockerd-build:2375]
    commands:
      - mkdir $HOME/.docker && echo "$DOCKER_CONFIG_JSON" > $HOME/.docker/config.json
      - mvn deploy -pl image -am -Dcheck.skip -DskipTests -T1C
    secrets: [DOCKER_CONFIG_JSON]

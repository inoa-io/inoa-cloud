<ng-template #gatewayTableMini>
    <mat-card class="gateway-mini-table">
        <mat-card-header>
            <div
                mat-card-avatar
                style="background-image: url('assets/inoa/satellite-color.png'); background-size: cover"></div>
            <mat-card-title>Satellites</mat-card-title>
        </mat-card-header>

        <mat-card-content class="mat-card-content-gateway-table">
            <div class="gateway-table-sub-container-mini">
                <table
                    mat-table
                    [dataSource]="dataSourceGateways"
                    matSort
                    #sortRef="matSort"
                    #tableRef
                    class="gateway-table">
                    <!-- Gateway ID Column -->
                    <ng-container matColumnDef="gateway_id">
                        <th
                            mat-header-cell
                            *matHeaderCellDef>
                            Satellite ID
                        </th>
                        <td
                            mat-cell
                            *matCellDef="let element">
                            {{ element.gateway_id }}
                        </td>
                    </ng-container>

                    <tr
                        mat-header-row
                        *matHeaderRowDef="displayedColumnsGatewayTableMini; sticky: true"></tr>
                    <tr
                        mat-row
                        *matRowDef="let dataRow; columns: displayedColumnsGatewayTableMini"
                        (click)="gatewayRowClicked(dataRow)"
                        class="element-row"
                        [ngClass]="{ 'element-row-selected': isRowSelected(dataRow) }"></tr>
                </table>
            </div>
        </mat-card-content>
    </mat-card>
</ng-template>

<mat-tab-group
    class="gateway-table-tab-group"
    [(selectedIndex)]="selectedTabIndex"
    headerPosition="below"
    color="primary"
    animationDuration="0ms"
    backgroundColor="primary">
    <mat-tab label="Satellite Table">
        <div
            class="gateway-table-container"
            tabindex="0">
            <mat-card class="cardGatewayTable">
                <mat-card-header>
                    <div
                        mat-card-avatar
                        style="background-image: url('assets/inoa/satellite-color.png'); background-size: cover"></div>
                    <mat-card-title>Satellite Management</mat-card-title>
                    <mat-card-subtitle>Check and maintain your INOA Satellites.</mat-card-subtitle>
                </mat-card-header>

                <mat-card-content class="mat-card-content-gateway-table">
                    <div class="gateway-table-sub-container">
                        <table
                            mat-table
                            [dataSource]="dataSourceGateways"
                            matSort
                            #sortRef="matSort"
                            #tableRef
                            class="gateway-table">
                            <!-- Selection Column -->
                            <ng-container matColumnDef="select">
                                <th
                                    mat-header-cell
                                    *matHeaderCellDef>
                                    <mat-checkbox
                                        (change)="$event ? toggleAllRows() : null"
                                        [checked]="selectionGateways.hasValue() && isAllSelected()"
                                        [indeterminate]="selectionGateways.hasValue() && !isAllSelected()"
                                        [aria-label]="checkboxLabel()">
                                    </mat-checkbox>
                                </th>
                                <td
                                    mat-cell
                                    *matCellDef="let row">
                                    <mat-checkbox
                                        (click)="$event.stopPropagation()"
                                        (change)="$event ? selectionGateways.toggle(row) : null"
                                        [checked]="selectionGateways.isSelected(row)"
                                        [aria-label]="checkboxLabel(row)">
                                    </mat-checkbox>
                                </td>
                            </ng-container>

                            <!-- Gateway ID Column -->
                            <ng-container matColumnDef="gateway_id">
                                <th
                                    mat-header-cell
                                    *matHeaderCellDef
                                    mat-sort-header>
                                    Satellite ID
                                </th>
                                <td
                                    mat-cell
                                    *matCellDef="let element">
                                    {{ element.gateway_id }}
                                </td>
                            </ng-container>

                            <!-- Gateway Name Column -->
                            <ng-container matColumnDef="name">
                                <th
                                    mat-header-cell
                                    *matHeaderCellDef
                                    mat-sort-header>
                                    Name
                                </th>
                                <td
                                    mat-cell
                                    *matCellDef="let element">
                                    {{ element.name }}
                                </td>
                            </ng-container>

                            <!-- Enabled Column -->
                            <ng-container matColumnDef="enabled">
                                <th
                                    mat-header-cell
                                    *matHeaderCellDef>
                                    Enabled
                                </th>
                                <td
                                    mat-cell
                                    *matCellDef="let element"
                                    class="mat-cell-center">
                                    <button
                                        mat-icon-button
                                        [matTooltip]="element.enabled ? 'Gateway is enabled' : 'Gateway is disabled'"
                                        matTooltipPosition="above"
                                        (click)="toggleEnabledClick(element, $event, !element.enabled)">
                                        <mat-icon
                                            *ngIf="element.enabled"
                                            aria-hidden="false"
                                            aria-label="Toggle On"
                                            fontIcon="toggle_on"></mat-icon>
                                        <mat-icon
                                            *ngIf="!element.enabled"
                                            aria-hidden="false"
                                            aria-label="Toggle Off"
                                            fontIcon="toggle_off"></mat-icon>
                                    </button>
                                </td>
                            </ng-container>

                            <!-- Connection Status Column -->
                            <ng-container matColumnDef="status">
                                <th
                                    mat-header-cell
                                    *matHeaderCellDef>
                                    Connected
                                </th>
                                <td
                                    mat-cell
                                    *matCellDef="let element"
                                    class="mat-cell-center">
                                    <mat-icon
                                        *ngIf="element.status.mqtt.connected"
                                        aria-hidden="false"
                                        aria-label="Link"
                                        fontIcon="link"
                                        style="color: green"></mat-icon>
                                    <mat-icon
                                        *ngIf="!element.status.mqtt.connected"
                                        aria-hidden="false"
                                        aria-label="Link Off"
                                        fontIcon="link_off"
                                        color="warn"></mat-icon>
                                </td>
                            </ng-container>

                            <!-- Actions Column -->
                            <ng-container matColumnDef="actions">
                                <th
                                    mat-header-cell
                                    *matHeaderCellDef
                                    style="text-align: center"></th>
                                <td
                                    mat-cell
                                    *matCellDef="let element; let rowIndex = index"
                                    style="width: 50px">
                                    <div style="display: flex">
                                        <button
                                            mat-icon-button
                                            matTooltip="Go to gatway terminal"
                                            matTooltipPosition="above"
                                            (click)="openConsoleClick(rowIndex, $event)"
                                            [disabled]="!element.enabled || !element.status.mqtt.connected">
                                            <mat-icon>terminal</mat-icon>
                                        </button>

                                        <button
                                            mat-icon-button
                                            matTooltip="Wink gateway LED"
                                            matTooltipPosition="above"
                                            (click)="winkClick(element, $event)"
                                            [disabled]="!element.enabled || !element.status.mqtt.connected">
                                            <mat-icon>remove_red_eye</mat-icon>
                                        </button>

                                        <button
                                            mat-icon-button
                                            matTooltip="Restart the gateway"
                                            matTooltipPosition="above"
                                            (click)="restartClick(element, $event)"
                                            [disabled]="!element.enabled || !element.status.mqtt.connected">
                                            <mat-icon>restart_alt</mat-icon>
                                        </button>
                                    </div>
                                </td>
                            </ng-container>

                            <tr
                                mat-header-row
                                *matHeaderRowDef="displayedColumnsGatewayTable; sticky: true"></tr>
                            <tr
                                mat-row
                                *matRowDef="let dataRow; columns: displayedColumnsGatewayTable"
                                (click)="gatewayRowClicked(dataRow)"
                                class="element-row"
                                [ngClass]="{ 'element-row-selected': isRowSelected(dataRow) }"></tr>
                        </table>
                    </div>

                    <div class="gateway-table-bottom-bar">
                        <div class="gateway-table-auto-refresh-select">
                            Auto refresh interval:
                            <mat-form-field
                                class="custom-height-select"
                                appearance="outline">
                                <mat-select
                                    [(ngModel)]="autoRefreshInterval"
                                    (ngModelChange)="onIntervalChange()">
                                    <mat-option
                                        *ngFor="let interval of autoRefreshIntervals"
                                        [value]="interval">
                                        {{ interval }}
                                    </mat-option>
                                </mat-select>
                            </mat-form-field>
                        </div>

                        <!-- page indicator Bottom -->
                        <mat-paginator
                            #paginatorRef
                            [length]="20"
                            [pageSizeOptions]="intercomService.pageSizes"
                            [pageSize]="intercomService.pageSize"
                            [pageIndex]="intercomService.pageNumber"
                            showFirstLastButtons
                            class="gateway-table-paginator">
                        </mat-paginator>
                    </div>
                </mat-card-content>
            </mat-card>
        </div>
    </mat-tab>

    <mat-tab
        label="Satellite Details"
        *ngIf="intercomService.selectedGateway">
        <div class="gateway-detail-container">
            <ng-container *ngTemplateOutlet="gatewayTableMini"></ng-container>

            <div class="gateway-detail-sub-container">
                <!-- Things connected to selected gateway table -->
                <mat-card class="cardGatewayThings">
                    <mat-card-header>
                        <div
                            mat-card-avatar
                            style="background-image: url('assets/inoa/satellite-color.png'); background-size: cover"></div>
                        <mat-card-title>Things connected to</mat-card-title>
                        <mat-card-subtitle>
                            <div class="gateway-status-container">
                                <span>{{ intercomService.selectedGateway.name }} ({{ intercomService.selectedGateway.gateway_id }})</span>

                                <!-- enabled icon -->
                                <mat-icon
                                    *ngIf="intercomService.selectedGateway.enabled"
                                    class="status-icon-scaled"
                                    aria-hidden="false"
                                    aria-label="Toggle On"
                                    fontIcon="toggle_on"></mat-icon>

                                <!-- disabled icon -->
                                <mat-icon
                                    *ngIf="!intercomService.selectedGateway.enabled"
                                    class="status-icon-scaled"
                                    aria-hidden="false"
                                    aria-label="Toggle Off"
                                    fontIcon="toggle_off"></mat-icon>

                                <!-- mqtt connected icon -->
                                <mat-icon
                                    *ngIf="intercomService.selectedGateway.status?.mqtt?.connected"
                                    class="status-icon-scaled"
                                    aria-hidden="false"
                                    aria-label="Link"
                                    fontIcon="link"
                                    style="color: green"></mat-icon>

                                <!-- mqtt not connected icon -->
                                <mat-icon
                                    *ngIf="!intercomService.selectedGateway.status?.mqtt?.connected"
                                    class="status-icon-scaled"
                                    aria-hidden="false"
                                    aria-label="Link Off"
                                    fontIcon="link_off"
                                    color="warn"></mat-icon>
                            </div>
                        </mat-card-subtitle>
                    </mat-card-header>

                    <mat-card-content class="mat-card-content-gateway-things">
                        <div
                            class="things-table"
                            tabindex="0">
                            <table
                                mat-table
                                [dataSource]="dataSourceThings">
                                <!-- ID Column -->
                                <ng-container matColumnDef="id">
                                    <th
                                        mat-header-cell
                                        *matHeaderCellDef>
                                        Thing ID
                                    </th>
                                    <td
                                        mat-cell
                                        *matCellDef="let element">
                                        {{ element.id }}
                                    </td>
                                </ng-container>

                                <!-- Name Column -->
                                <ng-container matColumnDef="name">
                                    <th
                                        mat-header-cell
                                        *matHeaderCellDef>
                                        Name
                                    </th>
                                    <td
                                        mat-cell
                                        *matCellDef="let element">
                                        {{ element.name }}
                                    </td>
                                </ng-container>

                                <!-- Thing Category -->
                                <ng-container matColumnDef="category">
                                    <th
                                        mat-header-cell
                                        *matHeaderCellDef>
                                        Category
                                    </th>
                                    <td
                                        mat-cell
                                        *matCellDef="let element">
                                        {{ utilityService.getThingCategory(element.thing_type_id).title }}
                                    </td>
                                </ng-container>

                                <!-- Gateway ID Column -->
                                <ng-container matColumnDef="gateway_id">
                                    <th
                                        mat-header-cell
                                        *matHeaderCellDef>
                                        Gateway ID
                                    </th>
                                    <td
                                        mat-cell
                                        *matCellDef="let element">
                                        {{ element.gateway_id }}
                                    </td>
                                </ng-container>

                                <!-- Thing ID Column -->
                                <ng-container matColumnDef="thing_type_id">
                                    <th
                                        mat-header-cell
                                        *matHeaderCellDef>
                                        Thing Type ID
                                    </th>
                                    <td
                                        mat-cell
                                        *matCellDef="let element">
                                        {{ element.thing_type_id }}
                                    </td>
                                </ng-container>

                                <!-- Config Column -->
                                <ng-container matColumnDef="config">
                                    <th
                                        mat-header-cell
                                        *matHeaderCellDef>
                                        Config
                                    </th>
                                    <td
                                        mat-cell
                                        *matCellDef="let element">
                                        {{ element.config }}
                                    </td>
                                </ng-container>

                                <!-- Actions Column -->
                                <ng-container matColumnDef="actions">
                                    <th
                                        mat-header-cell
                                        *matHeaderCellDef
                                        style="text-align: center"></th>
                                    <td
                                        mat-cell
                                        *matCellDef="let element; let rowIndex = index"
                                        style="width: 50px">
                                        <div style="display: flex">
                                            <button
                                                mat-icon-button
                                                matTooltip="Remove Thing"
                                                matTooltipPosition="above"
                                                (click)="removeThingClick(element, $event)">
                                                <mat-icon>delete</mat-icon>
                                            </button>
                                        </div>
                                    </td>
                                </ng-container>

                                <tr
                                    mat-header-row
                                    *matHeaderRowDef="displayedColumnsThingsTable; sticky: true"></tr>
                                <tr
                                    mat-row
                                    *matRowDef="let row; columns: displayedColumnsThingsTable"
                                    (click)="cellClickThings(row)"
                                    class="element-row"></tr>
                            </table>
                        </div>
                    </mat-card-content>

                    <mat-card-actions
                        class="card-actions"
                        align="end">
                        <!-- add button -->
                        <button
                            mat-raised-button
                            color="primary"
                            class="gateway-detail-action-button"
                            (click)="openCreateThingDialog()">
                            <mat-icon>add</mat-icon>
                            <span>Add</span>
                        </button>

                        <!-- restart button -->
                        <button
                            (click)="restartClick(intercomService.selectedGateway, $event)"
                            mat-raised-button
                            color="warn"
                            class="gateway-detail-action-button">
                            <mat-icon>restart_alt</mat-icon>
                            <span>Restart</span>
                        </button>
                    </mat-card-actions>
                </mat-card>

                <!-- possible measurements card (TODO: change to fold out table rows) -->
                <mat-card
                    class="cardGatewayMeasurements"
                    *ngIf="intercomService.selectedThing">
                    <mat-card-header>
                        <div
                            mat-card-avatar
                            style="background-image: url('assets/inoa/satellite-color.png'); background-size: cover"></div>
                        <mat-card-title>Measurements for</mat-card-title>
                        <mat-card-subtitle>{{ intercomService.selectedThing.name }}</mat-card-subtitle>
                    </mat-card-header>

                    <mat-card-content class="mat-card-content-gateway-measurements">
                        <div
                            class="measurements"
                            [formGroup]="measurements">
                            <mat-checkbox formControlName="water">Water</mat-checkbox>
                            <mat-checkbox formControlName="heat">Heat</mat-checkbox>
                            <mat-checkbox formControlName="power">Power</mat-checkbox>
                        </div>
                    </mat-card-content>

                    <mat-card-actions
                        class="card-actions"
                        align="end">
                        <!-- button to close the measurement -->
                        <button
                            mat-raised-button
                            color="primary"
                            class="gateway-detail-action-button"
                            (click)="closeMeasurementView()">
                            <mat-icon>close</mat-icon>
                            <span>Close</span>
                        </button>
                    </mat-card-actions>
                </mat-card>
            </div>
        </div>
    </mat-tab>

    <mat-tab
        label="Satellite Terminal"
        *ngIf="intercomService.selectedGateway">
        <div class="gateway-console-container">
            <ng-container *ngTemplateOutlet="gatewayTableMini"></ng-container>

            <mat-card class="cardConsole">
                <mat-card-header>
                    <div
                        mat-card-avatar
                        style="background-image: url('assets/inoa/satellite-color.png'); background-size: cover"></div>
                    <mat-card-title>RPC Command Editor for</mat-card-title>
                    <mat-card-subtitle>{{ intercomService.selectedGateway.name }} ({{ intercomService.selectedGateway.gateway_id }})</mat-card-subtitle>
                </mat-card-header>

                <mat-card-content class="mat-card-content-console">
                    <ngx-monaco-editor
                        class="monaco-editor"
                        [options]="monacoOptions"
                        [(ngModel)]="jsonCode">
                    </ngx-monaco-editor>
                </mat-card-content>

                <mat-card-actions
                    class="card-actions"
                    align="end">
                    <!-- send button -->
                    <button
                        mat-raised-button
                        color="warn"
                        class="console-action-button"
                        (click)="sendRPC()">
                        <mat-icon>upload</mat-icon>
                        <span>Send</span>
                    </button>
                </mat-card-actions>
            </mat-card>
        </div>
    </mat-tab>
</mat-tab-group>
